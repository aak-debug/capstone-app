name: CD - Build, Push and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/capstone-app

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Set image tag"
        id: set-tag
        run: |
          TAG=sha-${{ github.sha }}
          echo "DEBUG: computed TAG=$TAG"
          if [ -z "$TAG" ]; then
            echo "ERROR: TAG is empty" >&2
            exit 1
          fi
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

      - name: "Debug: show computed step output"
        run: |
          echo "DEBUG: steps.set-tag.outputs.image_tag='${{ steps.set-tag.outputs.image_tag }}'"

      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "Build and push image"
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.set-tag.outputs.image_tag }}

      - name: "Debug: show job outputs (final)"
        run: |
          echo "BUILD OUTPUTS:"
          echo "image_tag = ${{ steps.set-tag.outputs.image_tag }}"
          echo "GITHUB_SHA = ${{ github.sha }}"

  deploy-dev:
    name: "Deploy to dev (local)"
    needs: build-and-push
    runs-on: [self-hosted, linux, local]
    steps:
      - name: "Log in to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "Deploy to dev (local)"
        run: |
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          IMG_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          echo "DEBUG: IMAGE_NAME='$IMAGE_NAME'"
          echo "DEBUG: IMG_TAG='$IMG_TAG'"

          if [ -z "$IMG_TAG" ]; then
            echo "ERROR: image tag is empty. Aborting dev deploy."
            exit 1
          fi

          IMAGE="${IMAGE_NAME}:${IMG_TAG}"
          echo "DEBUG: FULL IMAGE='$IMAGE'"

          docker pull "$IMAGE"
          docker stop capstone-app || true
          docker rm capstone-app || true
          docker run -d --name capstone-app -p 8080:80 -e "APP_VERSION=${IMG_TAG}" "$IMAGE"

      - name: "Wait for container to start"
        run: sleep 5

      - name: "Health check (dev)"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
          if [ "$STATUS" -ne 200 ]; then
            echo "Dev health failed: $STATUS"
            docker logs capstone-app --tail 200 || true
            exit 1
          fi
          echo "Dev OK"

deploy-staging:
  name: "Deploy to staging"
  needs: deploy-dev
  runs-on: [self-hosted, linux, staging]
  environment: staging
  steps:
    - name: "Debug: show inputs"
      run: |
        echo "DEBUG: needs.build-and-push.outputs.image_tag='${{ needs.build-and-push.outputs.image_tag }}'"

    - name: "Deploy to staging"
      run: |
        IMAGE_NAME="${{ env.IMAGE_NAME }}"
        IMG_TAG="${{ needs.build-and-push.outputs.image_tag }}"

        # fallback to github.sha if the output was empty
        if [ -z "$IMG_TAG" ]; then
          echo "WARNING: image_tag empty â€” falling back to github.sha"
          IMG_TAG="sha-${{ github.sha }}"
        fi

        echo "DEBUG: IMAGE_NAME='$IMAGE_NAME'"
        echo "DEBUG: IMG_TAG='$IMG_TAG'"

        IMAGE="${IMAGE_NAME}:${IMG_TAG}"
        echo "DEBUG: FULL IMAGE='$IMAGE'"

        # pull and run
        docker pull "$IMAGE"
        docker stop capstone-app-stg || true
        docker rm capstone-app-stg || true
        docker run -d --name capstone-app-stg -p 8081:80 -e "APP_VERSION=${IMG_TAG}" "$IMAGE"

    - name: "Wait for container to start"
      run: sleep 5

    - name: "Staging healthcheck"
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/health || echo "000")
        if [ "$STATUS" -ne 200 ]; then
          echo "Staging health failed: $STATUS"
          docker logs capstone-app-stg --tail 200 || true
          exit 1
        fi
        echo "Staging OK"

  deploy-prod:
    name: "Deploy to production"
    needs: deploy-staging
    runs-on: [self-hosted, linux, production]
    environment: production
    steps:
      - name: "Debug: show inputs"
        run: |
          echo "DEBUG: needs.build-and-push.outputs.image_tag='${{ needs.build-and-push.outputs.image_tag }}'"

      - name: "Deploy to production"
        run: |
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          IMG_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          echo "DEBUG: IMAGE_NAME='$IMAGE_NAME'"
          echo "DEBUG: IMG_TAG='$IMG_TAG'"

          if [ -z "$IMG_TAG" ]; then
            echo "ERROR: image tag is empty. Aborting production deploy."
            exit 1
          fi

          IMAGE="${IMAGE_NAME}:${IMG_TAG}"
          echo "DEBUG: FULL IMAGE='$IMAGE'"

          docker pull "$IMAGE"
          docker stop capstone-app-prod || true
          docker rm capstone-app-prod || true
          docker run -d --name capstone-app-prod -p 80:80 -e "APP_VERSION=${IMG_TAG}" "$IMAGE"

      - name: "Wait for container to start"
        run: sleep 5

      - name: "Prod healthcheck"
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health || echo "000")
          if [ "$STATUS" -ne 200 ]; then
            echo "Prod health failed: $STATUS"
            docker logs capstone-app-prod --tail 200 || true
            exit 1
          fi
          echo "Prod OK"

